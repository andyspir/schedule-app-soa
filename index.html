<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Адаптивное расписание недели</title>
<link rel="icon" href="favicon.ico">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
/* ======= ОСНОВНЫЕ СТИЛИ ======= */

@media (max-width: 599px) {
    .day-title {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #ffffff;
        padding: 10px 0 8px 0;
        margin: 0 -8px 8px -8px;
        border-bottom: 1px solid #dcdcdc;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
}

html { scroll-behavior: smooth; }
body {
    font-family: Arial, sans-serif;
    background: #fafafa;
    margin: 20px;
}

.week-container {
    max-width: 1500px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
}

.day-column {
    border: 1px solid #333;
    border-radius: 10px;
    background: #ffffff;
    padding: 10px 8px 12px 8px;
    display: flex;
    flex-direction: column;
}

.day-title {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
}

.event {
    display: grid;
    grid-template-columns: 56px auto 60px;
    padding: 6px 6px;
    border-radius: 8px;
    margin-bottom: 4px;
    border: 1px solid #ccc;
    font-size: 12px;
}

.time { font-size: 11px; font-weight: bold; }
.text { font-size: 11px; }
.duration { text-align: right; font-size: 11px; font-weight: bold; }

.school     { background: #cce6ff; }
.music      { background: #ffe6cc; }
.homework   { background: #e6ffcc; }
.uchiru     { background: #e6ccff; }
.prep-music { background: #ffcccc; }
.default    { background: #f2f2f2; }

.highlight {
    border: 2px solid #ffae42 !important;
    background: #fff8e6 !important;
    box-shadow: 0 0 10px 3px rgba(255, 180, 80, 0.85) !important;
}

#tabletNowBtn {
    display: none;
    position: fixed;
    right: 12px;
    top: 12px;
    border: 1px solid #ccc;
    border-radius: 18px;
    padding: 6px 14px;
    font-size: 18px;
    background: #ffffff;
    z-index: 1100;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.mobile-side-nav {
    display: none;
    position: fixed;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    flex-direction: column;
    gap: 4px;
    z-index: 1200;
}

.mobile-side-nav button {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 4px 6px;
    font-size: 11px;
    background: #ffffff;
}

/* Адаптивность */
@media (max-width: 1199px) {
    .week-container { grid-template-columns: repeat(3, 1fr); }
}
@media (min-width: 600px) and (max-width: 1199px) {
    #tabletNowBtn { display: block; }
}
@media (max-width: 899px) {
    .week-container { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 599px) {
    body { margin: 10px; }
    .week-container { grid-template-columns: 1fr; }
    .day-column { display: none; }
    .day-column.active-day { display: flex; }
    .mobile-side-nav { display: flex; }
    #tabletNowBtn { display: none !important; }
}
</style>
</head>

<body>

<button id="tabletNowBtn">▶️</button>

<div class="mobile-side-nav" id="mobileSideNav">
    <button data-day-index="0">ПН</button>
    <button data-day-index="1">ВТ</button>
    <button data-day-index="2">СР</button>
    <button data-day-index="3">ЧТ</button>
    <button data-day-index="4">ПТ</button>
    <button id="mobileNowBtn">▶️</button>
</div>

<div class="week-container" id="weekContainer"></div>

<script>
/* ============================================================
   ГЛОБАЛЬНЫЕ ДАННЫЕ (ускорение)
============================================================ */
let SCHEDULE = null;
let EVENT_MAP = {};

/* ============================================================
   КОНСТАНТЫ
============================================================ */
const SHEET_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYBAcXFTIcphfEyjNyTszMEGJxuhTHoGZC-6nL7aLjokDPKGgLHRCWvLTBfK2Pu9wUohRstIk9Rxg7/pub?gid=0&single=true&output=csv";

const DAY_KEYS = ['mon','tue','wed','thu','fri'];
const DAY_TITLES = {
    mon:'Понедельник', tue:'Вторник',
    wed:'Среда', thu:'Четверг', fri:'Пятница'
};

/* ============================================================
   CSV ПАРСЕР
============================================================ */
function parseCSVLine(line) {
    const res = [];
    let cur = '';
    let inside = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"' && line[i+1] === '"') { cur += '"'; i++; }
        else if (c === '"') inside = !inside;
        else if (c === ',' && !inside) { res.push(cur); cur=''; }
        else cur += c;
    }
    res.push(cur);
    return res;
}

/* ============================================================
   ВРЕМЯ + ДЛИТЕЛЬНОСТЬ
============================================================ */
function timeToMinutes(t){
    const [h,m] = t.split(':').map(Number);
    return h*60 + m;
}

function formatDuration(start,end){
    let d = timeToMinutes(end) - timeToMinutes(start);
    if (d < 0) d += 1440;
    const h = Math.floor(d/60);
    const m = d % 60;
    if (h === 0 && m === 0) return "0 мин";
    return (h ? h + " ч " : "") + (m ? m + " мин" : "");
}

/* ============================================================
   ЗАГРУЗКА РАСПИСАНИЯ (1 раз)
============================================================ */
async function loadSchedule(){
    const text = await fetch(SHEET_CSV_URL).then(r=>r.text());
    const lines = text.trim().split("\n");

    const data = {mon:[],tue:[],wed:[],thu:[],fri:[]};

    for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < 5) continue;

        const day   = cols[0].trim();
        const start = cols[1].trim();
        let   end   = cols[2].trim();
        const text  = cols[3].trim();
        const type  = cols[4].trim() || "default";

        if (!day || !start || !text) continue;
        if (!data[day]) continue;

        data[day].push({ day, start, end, text, type });
    }

    for (const k of DAY_KEYS) {
        const arr = data[k];
        arr.sort((a,b)=> timeToMinutes(a.start) - timeToMinutes(b.start));

        if (arr.length) {
            const last = arr[arr.length - 1];
            if (!last.end) last.end = "06:30";
        }
    }

    return data;
}

/* ============================================================
   РЕНДЕР DOM (по глобальному SCHEDULE)
============================================================ */
function renderSchedule(){
    const wrap = document.getElementById("weekContainer");
    wrap.innerHTML = "";

    EVENT_MAP = {};

    for (const key of DAY_KEYS) {
        const col = document.createElement("div");
        col.className = "day-column";
        col.id = key;

        const title = document.createElement("div");
        title.className = "day-title";
        title.textContent = DAY_TITLES[key];
        col.appendChild(title);

        EVENT_MAP[key] = [];

        for (const ev of SCHEDULE[key]) {
            const box = document.createElement("div");
            box.className = "event " + ev.type;
            box.dataset.start = ev.start;
            box.dataset.end = ev.end;

            box.innerHTML = `
                <div class="time">${ev.start}</div>
                <div class="text">${ev.text}</div>
                <div class="duration">${formatDuration(ev.start, ev.end)}</div>
            `;

            EVENT_MAP[key].push(box);
            col.appendChild(box);
        }

        wrap.appendChild(col);
    }
}

/* ============================================================
   ПОДСВЕТКА
============================================================ */
function clearHighlight(){
    document.querySelectorAll(".highlight").forEach(el=>el.classList.remove("highlight"));
}

function highlightEvent(ev, scroll = true){
    clearHighlight();
    if (!ev) return;
    ev.classList.add("highlight");
    if (scroll) ev.scrollIntoView({behavior:"smooth", block:"center"});
}

function getTodayKey(){
    const map = {1:'mon',2:'tue',3:'wed',4:'thu',5:'fri'};
    return map[new Date().getDay()] || "mon";
}

function isWeekend(){
    const d = new Date().getDay();
    return d === 0 || d === 6;
}

function findCurrentEvent(day){
    const arr = EVENT_MAP[day];
    if (!arr || !arr.length) return null;

    const now = new Date();
    const m = now.getHours()*60 + now.getMinutes();

    let best = arr[0];
    for (const el of arr) {
        const s = timeToMinutes(el.dataset.start);
        const e = timeToMinutes(el.dataset.end);
        if (m >= s && m < e) return el;
        if (m >= s) best = el;
    }
    return best;
}

function getFirstEvent(day){
    return EVENT_MAP[day]?.[0] || null;
}

/* ============================================================
   РЕЖИМЫ
============================================================ */
let currentMode = null;
let activeMobileDay = 0;

function isMobile(){
    return window.innerWidth < 600;
}

function applyDesktopMode(){
    currentMode = "desktop";

    document.querySelectorAll(".day-column").forEach(col=>{
        col.style.display = "flex";
        col.classList.remove("active-day");
    });

    let ev = null;
    if (isWeekend()) {
        ev = getFirstEvent("mon");
    } else {
        const today = getTodayKey();
        ev = findCurrentEvent(today) || getFirstEvent(today);
    }

    highlightEvent(ev);
}

function applyMobileMode(initial=false){
    currentMode = "mobile";

    if (initial) {
        const idx = DAY_KEYS.indexOf(getTodayKey());
        activeMobileDay = idx >= 0 ? idx : 0;
    }

    const key = DAY_KEYS[activeMobileDay];

    document.querySelectorAll(".day-column").forEach(col=>{
        if (col.id === key) {
            col.style.display = "flex";
            col.classList.add("active-day");
        } else {
            col.style.display = "none";
            col.classList.remove("active-day");
        }
    });

    let ev = null;
    if (isWeekend()) {
        ev = getFirstEvent("mon");
    } else {
        ev = findCurrentEvent(key) || getFirstEvent(key);
    }

    highlightEvent(ev);
}

function updateLayout(initial=false){
    if (isMobile()) {
        if (initial || currentMode !== "mobile") applyMobileMode(true);
        else applyMobileMode(false);
    } else {
        if (initial || currentMode !== "desktop") applyDesktopMode();
    }
}

/* ============================================================
   RESIZE DEBOUNCE
============================================================ */
let resizeTimer = null;
window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>updateLayout(false), 150);
});

/* ============================================================
   ИНИЦИАЛИЗАЦИЯ
============================================================ */
document.addEventListener("DOMContentLoaded", async () => {
    SCHEDULE = await loadSchedule();   // загрузка 1 раз
    renderSchedule();                  // генерируем DOM
    updateLayout(true);                // применяем режим

    document.querySelectorAll('#mobileSideNav button[data-day-index]')
        .forEach(btn => {
            btn.addEventListener("click", () => {
                activeMobileDay = parseInt(btn.dataset.dayIndex);
                applyMobileMode(false);
            });
        });

    document.getElementById("mobileNowBtn").onclick = () => {
        const idx = DAY_KEYS.indexOf(getTodayKey());
        activeMobileDay = idx >= 0 ? idx : 0;
        applyMobileMode(false);
    };

    document.getElementById("tabletNowBtn").onclick = () => {
        applyDesktopMode();
    };
});
</script>

</body>
</html>
