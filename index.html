<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏</title>
<link rel="icon" href="favicon.ico">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
/* ======= –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ======= */

@media (max-width: 599px) {
    .day-title {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #ffffff;
        padding: 10px 0 8px 0;
        margin: 0 -8px 8px -8px;
        border-bottom: 1px solid #dcdcdc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        text-align: center;
    }
}

html { scroll-behavior: smooth; }

body {
    font-family: Arial, sans-serif;
    background: #fafafa;
    margin: 20px;
}

.week-container {
    max-width: 1500px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
}

.day-column {
    border: 1px solid #333;
    border-radius: 10px;
    background: #ffffff;
    padding: 10px 8px 12px 8px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
}

.day-title {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
}

.event {
    display: grid;
    grid-template-columns: 56px auto 60px;
    padding: 6px 6px;
    border-radius: 8px;
    margin-bottom: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 12px;
}

.time { font-size: 11px; font-weight: bold; }
.text { font-size: 11px; white-space: normal; }
.duration { text-align: right; font-size: 11px; font-weight: bold; }

.school     { background: #cce6ff; }
.music      { background: #ffe6cc; }
.homework   { background: #e6ffcc; }
.uchiru     { background: #e6ccff; }
.prep-music { background: #ffcccc; }
.default    { background: #f2f2f2; }

.highlight {
    border: 2px solid #ffae42 !important;
    background: #fff8e6 !important;
    box-shadow: 0 0 10px 3px rgba(255, 180, 80, 0.85) !important;
}

/* –ö–Ω–æ–ø–∫–∞ "—Å–µ–π—á–∞—Å" –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
#tabletNowBtn {
    display: none;
    position: fixed;
    right: 12px;
    top: 12px;
    z-index: 1100;
    border: 1px solid #ccc;
    border-radius: 18px;
    padding: 6px 14px;
    font-size: 18px;
    background: #ffffff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
.mobile-side-nav {
    display: none;
    position: fixed;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1200;
    flex-direction: column;
    gap: 4px;
}

.mobile-side-nav button {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 4px 6px;
    font-size: 11px;
    background: #ffffff;
    min-width: 32px;
    text-align: center;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —à–∏—Ä–∏–Ω–µ */
@media (max-width: 1199px) {
    .week-container { grid-template-columns: repeat(3, 1fr); }
}

@media (min-width: 600px) and (max-width: 1199px) {
    #tabletNowBtn { display: block; }
}

@media (max-width: 899px) {
    .week-container { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 599px) {
    body { margin: 10px; }
    .week-container { grid-template-columns: 1fr; }
    .day-column { display: none; }
    .day-column.active-day { display: flex; }
    .mobile-side-nav { display: flex; }
    #tabletNowBtn { display: none !important; }
}
</style>

</head>
<body>

<button id="tabletNowBtn">‚ñ∂Ô∏è</button>

<div class="mobile-side-nav" id="mobileSideNav">
    <button data-day-index="0">–ü–ù</button>
    <button data-day-index="1">–í–¢</button>
    <button data-day-index="2">–°–†</button>
    <button data-day-index="3">–ß–¢</button>
    <button data-day-index="4">–ü–¢</button>
    <button id="mobileNowBtn">‚ñ∂Ô∏è</button>
</div>

<div class="week-container" id="weekContainer"></div>

<div id="updateBanner" style="display:none; position:fixed; left:0; right:0; bottom:0; background:#ffebcc; padding:10px; text-align:center;">
    –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    <button id="updateBtn" style="padding:4px 10px; background:#ffae42; border:none;">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>

<script>
/* ============================================================
   CSV + –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò
============================================================ */

const SHEET_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYBAcXFTIcphfEyjNyTszMEGJxuhTHoGZC-6nL7aLjokDPKGgLHRCWvLTBfK2Pu9wUohRstIk9Rxg7/pub?gid=0&single=true&output=csv";

const DAY_KEYS = ['mon','tue','wed','thu','fri'];
const DAY_TITLES = {
    mon:'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', tue:'–í—Ç–æ—Ä–Ω–∏–∫',
    wed:'–°—Ä–µ–¥–∞', thu:'–ß–µ—Ç–≤–µ—Ä–≥', fri:'–ü—è—Ç–Ω–∏—Ü–∞'
};

/* –£–º–Ω—ã–π CSV –ø–∞—Ä—Å–µ—Ä */
function parseCSVLine(line) {
    const result = [];
    let cur = '';
    let inside = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"' && line[i+1] === '"') { cur += '"'; i++; }
        else if (c === '"') inside = !inside;
        else if (c === ',' && !inside) { result.push(cur); cur=''; }
        else cur += c;
    }
    result.push(cur);
    return result;
}

/* –í—Ä–µ–º—è */
function timeToMinutes(t){
    const [h,m] = t.split(':').map(Number);
    return h*60 + m;
}

function formatDuration(start,end){
    let d = timeToMinutes(end) - timeToMinutes(start);
    if (d < 0) d += 1440;
    const h = Math.floor(d/60);
    const m = d % 60;
    const parts = [];
    if (h > 0) parts.push(h + ' —á');
    if (m > 0) parts.push(m + ' –º–∏–Ω');
    if (!parts.length) parts.push('0 –º–∏–Ω');
    return parts.join(' ');
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
async function loadSchedule(){
    const resp = await fetch(SHEET_CSV_URL);
    const csv = await resp.text();
    const lines = csv.trim().split('\n');

    const schedule = {mon:[],tue:[],wed:[],thu:[],fri:[]};

    for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < 5) continue;

        const day   = (cols[0] || '').trim();
        const start = (cols[1] || '').trim();
        let   end   = (cols[2] || '').trim();
        const text  = (cols[3] || '').trim();
        const type  = (cols[4] || '').trim() || 'default';

        if (!day || !start || !text) continue;
        if (!schedule[day]) continue;

        schedule[day].push({ day, start, end, text, type });
    }

    for (const k of DAY_KEYS) {
        const arr = schedule[k];
        if (!arr.length) continue;

        arr.sort((a,b) => timeToMinutes(a.start) - timeToMinutes(b.start));

        const last = arr[arr.length - 1];
        if (!last.end || last.end.trim() === '') last.end = '06:30';
    }

    return schedule;
}

/* ============================================================
   –†–ï–ù–î–ï–† –†–ê–°–ü–ò–°–ê–ù–ò–Ø
============================================================ */

async function renderSchedule(){
    const data = await loadSchedule();
    const wrap = document.getElementById('weekContainer');
    wrap.innerHTML = '';

    for (const day of DAY_KEYS) {
        const col = document.createElement('div');
        col.className = 'day-column';
        col.id = day;

        const title = document.createElement('div');
        title.className = 'day-title';
        title.textContent = DAY_TITLES[day];
        col.appendChild(title);

        (data[day] || []).forEach(ev => {
            const box = document.createElement('div');
            box.className = 'event ' + ev.type;

            box.dataset.day   = ev.day;
            box.dataset.start = ev.start;
            box.dataset.end   = ev.end;

            box.innerHTML = `
              <div class="time">${ev.start}</div>
              <div class="text">${ev.text}</div>
              <div class="duration">${formatDuration(ev.start, ev.end)}</div>
            `;

            /* üî• –§–ò–ö–° ‚Äî —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ */
            box.classList.remove("highlight");

            col.appendChild(box);
        });

        wrap.appendChild(col);
    }
}

/* ============================================================
   –ü–û–î–°–í–ï–¢–ö–ê + –†–ï–ñ–ò–ú–´
============================================================ */

function getTodayKey(){
    const map = {1:'mon',2:'tue',3:'wed',4:'thu',5:'fri'};
    return map[new Date().getDay()] || 'mon';
}

function isTodayWeekend(){
    const d = new Date().getDay(); // 0=–í–°,6=–°–ë
    return d === 0 || d === 6;
}

function findCurrentEvent(day){
    const now = new Date();
    const m = now.getHours()*60 + now.getMinutes();
    const list = [...document.querySelectorAll(`.event[data-day="${day}"]`)];
    if (!list.length) return null;

    let best = list[0];
    for (const ev of list) {
        const s = timeToMinutes(ev.dataset.start);
        const e = timeToMinutes(ev.dataset.end);
        if (m >= s && m < e) return ev;
        if (m >= s) best = ev;
    }
    return best;
}

function getFirstEvent(day){
    return document.querySelector(`.event[data-day="${day}"]`);
}

function clearHighlight(){
    document.querySelectorAll('.event.highlight')
        .forEach(el => el.classList.remove('highlight'));
}

function highlight(ev){
    clearHighlight();
    if (ev) {
        ev.classList.add('highlight');
        ev.scrollIntoView({ behavior:'smooth', block:'center' });
    }
}

function isMobile(){
    return window.innerWidth < 600;
}

let currentMode = null;
let activeMobileDayIndex = 0;

/* === –î–ï–°–ö–¢–û–ü === */
function applyDesktopMode(){
    currentMode = 'desktop';

    document.querySelectorAll('.day-column').forEach(col => {
        col.style.display = 'flex';
        col.classList.remove('active-day');
    });

    clearHighlight();

    let ev = null;

    if (isTodayWeekend()) {
        ev = getFirstEvent('mon');
    } else {
        const todayKey = getTodayKey();
        ev = findCurrentEvent(todayKey);
        if (!ev) ev = getFirstEvent(todayKey);
    }

    highlight(ev);
}

/* === –ú–û–ë–ò–õ–¨–ù–´–ô –†–ï–ñ–ò–ú === */
function applyMobileMode(initial=false){
    currentMode = 'mobile';

    if (initial) {
        const todayKey = getTodayKey();
        const idx = DAY_KEYS.indexOf(todayKey);
        activeMobileDayIndex = idx >= 0 ? idx : 0;
    }

    const activeKey = DAY_KEYS[activeMobileDayIndex];

    /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å */
    document.querySelectorAll('.day-column').forEach(col => {
        if (col.id === activeKey) {
            col.style.display = 'flex';
            col.classList.add('active-day');
        } else {
            col.style.display = 'none';
            col.classList.remove('active-day');
        }
    });

    clearHighlight();

let ev;

if (isTodayWeekend()) {
    // –í –≤—ã—Ö–æ–¥–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫,
    // –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏—Å—Ç–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–Ω–∏
    ev = getFirstEvent('mon');
} else {
    // –ë—É–¥–Ω–∏ ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞ —Ç–æ–ª—å–∫–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–Ω–µ
    ev = findCurrentEvent(activeKey);
    if (!ev) ev = getFirstEvent(activeKey);
}

highlight(ev);

}

function setMobileDay(i){
    activeMobileDayIndex = (i + DAY_KEYS.length) % DAY_KEYS.length;
    if (currentMode === 'mobile') applyMobileMode(false);
}

function updateLayout(initial=false){
    if (isMobile()) {
        if (initial || currentMode !== 'mobile') applyMobileMode(true);
        else applyMobileMode(false);
    } else {
        if (initial || currentMode !== 'desktop') applyDesktopMode();
    }
}

/* ============================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
============================================================ */

document.addEventListener('DOMContentLoaded', async () => {
    await renderSchedule();
    updateLayout(true);

    document.querySelectorAll('#mobileSideNav button[data-day-index]')
        .forEach(btn => {
            btn.addEventListener('click', () => {
                setMobileDay(parseInt(btn.dataset.dayIndex));
            });
        });

    document.getElementById('mobileNowBtn').onclick = () => {
        setMobileDay(DAY_KEYS.indexOf(getTodayKey()));
    };

    document.getElementById('tabletNowBtn').onclick = () => {
        applyDesktopMode();
    };

    window.addEventListener('resize', () => updateLayout(false));
});

/* ============================================================
   PWA
============================================================ */

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
        if (reg.waiting) showUpdateBanner(reg);
        reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            nw.addEventListener('statechange', () => {
                if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                    showUpdateBanner(reg);
                }
            });
        });
    });
}

function showUpdateBanner(reg){
    const banner = document.getElementById('updateBanner');
    banner.style.display = 'block';
    document.getElementById('updateBtn').onclick = () => {
        if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
        location.reload();
    };
}
</script>

</body>
</html>


