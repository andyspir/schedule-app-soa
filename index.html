<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Адаптивное расписание недели</title>
<link rel="icon" href="favicon.ico">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
/* ======= СТИЛИ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ ======= */

@media (max-width: 599px) {
    .day-title {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #ffffff;
        padding: 10px 0 8px 0;
        margin: 0 -8px 8px -8px;
        border-bottom: 1px solid #dcdcdc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        text-align: center;
    }
}

html { scroll-behavior: smooth; }

body {
    font-family: Arial, sans-serif;
    background: #fafafa;
    margin: 20px;
}

.week-container {
    max-width: 1500px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
}

.day-column {
    border: 1px solid #333;
    border-radius: 10px;
    background: #ffffff;
    padding: 10px 8px 12px 8px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
}

.day-title {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
}

.event {
    display: grid;
    grid-template-columns: 56px auto 60px;
    padding: 6px 6px;
    border-radius: 8px;
    margin-bottom: 4px;
    border: 1px solid #ccc;
   box-sizing: border-box;
    font-size: 12px;
}

.time { font-size: 11px; font-weight: bold; }
.text { font-size: 11px; white-space: normal; }
.duration { text-align: right; font-size: 11px; font-weight: bold; }

.school { background: #cce6ff; }
.music { background: #ffe6cc; }
.homework { background: #e6ffcc; }
.uchiru { background: #e6ccff; }
.prep-music { background: #ffcccc; }
.default { background: #f2f2f2; }

.highlight {
    border: 2px solid #ffae42 !important;
    background: #fff8e6 !important;
    box-shadow: 0 0 10px 3px rgba(255, 180, 80, 0.85) !important;
}

#tabletNowBtn {
    display: none;
    position: fixed;
    right: 12px;
    top: 12px;
    z-index: 1100;
    border: 1px solid #ccc;
    border-radius: 18px;
    padding: 6px 14px;
    font-size: 18px;
    background: #ffffff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.mobile-side-nav {
    display: none;
    position: fixed;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1200;
    flex-direction: column;
    gap: 4px;
}

.mobile-side-nav button {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 4px 6px;
    font-size: 11px;
    background: #ffffff;
    min-width: 32px;
    text-align: center;
}

/* адаптивность */
@media (max-width: 1199px) {
    .week-container { grid-template-columns: repeat(3, 1fr); }
}

@media (min-width: 600px) and (max-width: 1199px) {
    #tabletNowBtn { display: block; }
}

@media (max-width: 899px) { .week-container { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 599px) {
    body { margin: 10px; }
    .week-container { grid-template-columns: 1fr; }
    .day-column { display: none; }
    .day-column.active-day { display: flex; }
    .mobile-side-nav { display: flex; }
    #tabletNowBtn { display: none !important; }
}
</style>

</head>
<body>

<button id="tabletNowBtn">▶️</button>

<!-- Мобильная навигация -->
<div class="mobile-side-nav" id="mobileSideNav">
    <button data-day-index="0">ПН</button>
    <button data-day-index="1">ВТ</button>
    <button data-day-index="2">СР</button>
    <button data-day-index="3">ЧТ</button>
    <button data-day-index="4">ПТ</button>
    <button id="mobileNowBtn">▶️</button>
</div>

<div class="week-container" id="weekContainer"></div>

<!-- Баннер обновления -->
<div id="updateBanner" style="display:none; position:fixed; left:0; right:0; bottom:0; background:#ffebcc; padding:10px; text-align:center;">
    Доступна новая версия приложения.
    <button id="updateBtn" style="padding:4px 10px; background:#ffae42; border:none;">Обновить</button>
</div>


<!-- ====================== СКРИПТЫ ====================== -->
<script>
// === CSV источник ===
const SHEET_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYBAcXFTIcphfEyjNyTszMEGJxuhTHoGZC-6nL7aLjokDPKGgLHRCWvLTBfK2Pu9wUohRstIk9Rxg7/pub?gid=0&single=true&output=csv";

const DAY_KEYS = ['mon', 'tue', 'wed', 'thu', 'fri'];
const DAY_TITLES = { mon:'Понедельник', tue:'Вторник', wed:'Среда', thu:'Четверг', fri:'Пятница' };

function timeToMinutes(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }

function formatDuration(start,end){
  let d = timeToMinutes(end) - timeToMinutes(start);
  if(d<0) d += 1440;
  const h = Math.floor(d/60);
  const m = d % 60;
  return (h>0? h+" ч ":"") + (m>0? m+" мин": "");
}

async function loadSchedule(){
  const r = await fetch(SHEET_CSV_URL);
  const csv = await r.text();
  const lines = csv.trim().split("\n");

  const schedule = {mon:[],tue:[],wed:[],thu:[],fri:[]};

  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    if(cols.length<5) continue;

    const day=cols[0], start=cols[1], end=cols[2], text=cols[3], type=cols[4]||"default";
    if(schedule[day]) schedule[day].push({day,start,end,text,type});
  }

  for(const k of DAY_KEYS) schedule[k].sort((a,b)=> timeToMinutes(a.start)-timeToMinutes(b.start));
    // === Автоматическая логика для последнего блока ===
for (const k of DAY_KEYS) {
    const dayEvents = schedule[k];
    if (dayEvents.length === 0) continue;

    const last = dayEvents[dayEvents.length - 1];

    // Если время окончания пустое — задаём окончание = 06:30 следующего дня
    if (!last.end || last.end.trim() === "") {
        last.end = "06:30";  // фиксированное окончание следующего дня
    }
}

  return schedule;
}

async function render(){
  const data = await loadSchedule();
  const wrap = document.getElementById("weekContainer");
  wrap.innerHTML = "";

  for(const day of DAY_KEYS){
    const col = document.createElement("div");
    col.className = "day-column";
    col.id = day;

    const title = document.createElement("div");
    title.className = "day-title";
    title.textContent = DAY_TITLES[day];
    col.appendChild(title);

    data[day].forEach(ev=>{
      const box = document.createElement("div");
      box.className = "event " + ev.type;

      box.dataset.day = ev.day;
      box.dataset.start = ev.start;
      box.dataset.end = ev.end;

      box.innerHTML = `
        <div class="time">${ev.start}</div>
        <div class="text">${ev.text}</div>
        <div class="duration">${formatDuration(ev.start,ev.end)}</div>
      `;

      col.appendChild(box);
    });

    wrap.appendChild(col);
  }
}

// ===== ЛОГИКА ПОДСВЕТКИ, МОБИЛЬНОЙ НАВИГАЦИИ И PWA =====
// (оставляю как было — всё рабочее)

function getTodayKey(){
    const map = {
        1: "mon",
        2: "tue",
        3: "wed",
        4: "thu",
        5: "fri"
    };
    return map[new Date().getDay()] || "mon"; // Если выходной — всегда понедельник
}


function findCurrentEvent(day){
  const now = new Date();
  const m = now.getHours()*60 + now.getMinutes();
  const list = [...document.querySelectorAll(`.event[data-day="${day}"]`)];
  let best = list[0];
  for(const ev of list){
    const s = timeToMinutes(ev.dataset.start);
    const e = timeToMinutes(ev.dataset.end);
    if(m>=s && m<e) return ev;
    if(m>=s) best=ev;
  }
  return best;
}

function highlight(ev){
  document.querySelectorAll(".highlight").forEach(x=>x.classList.remove("highlight"));
  if(ev){
    ev.classList.add("highlight");
    ev.scrollIntoView({behavior:"smooth",block:"center"});
  }
}

function isMobile(){ return innerWidth<600; }

let activeIndex=0;

function setMobileDay(i){
  activeIndex = (i+5)%5;
  const key = DAY_KEYS[activeIndex];

  document.querySelectorAll(".day-column").forEach(c=>{
    c.classList.toggle("active-day", c.id===key);
  });

  if(getTodayKey()===key){
    const ev = findCurrentEvent(key);
    highlight(ev);
  }
}

// ---- ИНИЦИАЛИЗАЦИЯ ----
document.addEventListener("DOMContentLoaded", async ()=>{
  await render();

  // начальный выбор дня на мобильном
  if (isMobile()) {
    const today = getTodayKey();
    let idx = DAY_KEYS.indexOf(today);
    if (idx < 0) idx = 0;
    setMobileDay(idx);
  }

  // обработчики кнопок боковой навигации на смартфоне
  const sideNav = document.getElementById("mobileSideNav");
  if (sideNav) {
    const dayButtons = sideNav.querySelectorAll("button[data-day-index]");
    dayButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.dataset.dayIndex, 10);
        setMobileDay(idx);
      });
    });

    const mobileNowBtn = document.getElementById("mobileNowBtn");
    if (mobileNowBtn) {
      mobileNowBtn.addEventListener("click", () => {
        const today = getTodayKey();
        let idx = DAY_KEYS.indexOf(today);
        if (idx < 0) idx = 0;
        setMobileDay(idx);
      });
    }
  }

  // реакция на изменение размера окна
  window.addEventListener("resize", () => {
    if (!isMobile()) {
      document.querySelectorAll(".day-column").forEach(c => c.style.display = "flex");
    }
  });
});

// ---- PWA обновление ----
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js").then(reg=>{
    if(reg.waiting) showUpdate(reg);
    reg.addEventListener("updatefound",()=>{
      const nw = reg.installing;
      nw.addEventListener("statechange",()=>{
        if(nw.state==="installed" && navigator.serviceWorker.controller){
          showUpdate(reg);
        }
      });
    });
  });
}

function showUpdate(reg){
  const b=document.getElementById("updateBanner");
  b.style.display="block";
  document.getElementById("updateBtn").onclick=()=>{
    reg.waiting.postMessage("SKIP_WAITING");
    location.reload();
  };
}
</script>

</body>
</html>





